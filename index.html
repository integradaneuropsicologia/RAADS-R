<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RAADS-R — Ritvo Autism Asperger Diagnostic Scale - Revised</title>
<meta name="description" content="Formulário RAADS-R para triagem de características do espectro autista em adultos. Integrada Neuropsicologia.">
<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --line:#1f2937;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --pri:#14532d;
  --ok:#22c55e;
  --err:#ef4444;
  --chip:#0b1220;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.wrap{
  max-width:1000px;
  margin:24px auto;
  padding:0 16px;
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:14px;
  padding:20px;
  box-shadow:0 0 10px #0004;
}
h1{font-size:1.35rem;margin-bottom:4px}
.muted{color:var(--muted)}
.grid-info{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin:16px 0;
}
@media(max-width:720px){.grid-info{grid-template-columns:1fr}}
.info{
  background:var(--chip);
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
}
.info b{display:block;color:#cbd5e1;margin-bottom:4px}
.q{
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--chip);
  padding:12px;
  margin-bottom:10px;
}
.q h3{margin:0 0 6px;font-size:.95rem}
.opts{display:flex;flex-wrap:wrap;gap:8px}
label.opt{
  display:flex;
  align-items:center;
  gap:6px;
  background:#111827;
  border:1px solid #1f2937;
  border-radius:9px;
  padding:6px 10px;
  cursor:pointer;
}
label.opt:has(input[type="radio"]:checked){
  background:var(--pri);
  border-color:var(--pri);
  color:#fff;
}
label.opt input{accent-color:var(--pri)}
.btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:var(--ok);
  border:none;
  border-radius:10px;
  color:#fff;
  padding:10px 14px;
  cursor:pointer;
  font-weight:600;
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.msg{margin:10px 0;padding:10px;border-radius:8px}
.okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
.errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
.warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>RAADS-R — Ritvo Autism Asperger Diagnostic Scale – Revised</h1>
    <p class="muted">
      Para cada afirmação, selecione a opção que melhor descreve você.  
      As opções são: <b>Nunca foi verdadeiro</b>, <b>Verdadeiro apenas quando eu tinha menos de 16 anos</b>,  
      <b>Verdadeiro apenas hoje</b> e <b>Verdadeiro hoje e quando eu era jovem</b>.
    </p>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="display:none;">
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center">
        <button id="btnSubmit" class="btn" type="submit">Enviar respostas</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// =============================
// CONFIGURAÇÃO GERAL RAADS-R
// =============================
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = {
  PATIENTS: "Patients",
  TOKENS: "LinkTokens",
  SCORES: "Scores_RAADS-R"
};
const CODE = "RAADS-R";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const SOURCE = "paciente";

const $ = s => document.querySelector(s);
const qs = k => new URLSearchParams(location.search).get(k) || "";
const onlyDigits = s => (s || "").replace(/\D+/g,"");
const AUTOSAVE_KEY = `${CODE}_${qs("token") || "no_token"}`;

// =============================
// FUNÇÕES AUXILIARES
// =============================
function setBox(id, text, kind="ok"){
  const el = $(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok" ? "okbox" : kind==="warn" ? "warnbox" : "errbox");
  el.style.display = "block";
}
function hideBox(id){const el=$(id);if(el){el.style.display="none";el.textContent="";}}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return (y&&m&&d)?`${d}/${m}/${y}`:iso;
}
async function GET(url){const r=await fetch(url);if(!r.ok)throw new Error("HTTP "+r.status);return r.json();}
async function POST(url,body){
  const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(await r.text());
  return r.json();
}
async function PATCH(url,body){
  const r=await fetch(url,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!r.ok)throw new Error(await r.text());
  return r.json();
}
async function sheetSearch(sheet,params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet,row){
  return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{data:[row]});
}
async function sheetPatchBy(sheet,col,val,data){
  return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(col)}/${encodeURIComponent(val)}?sheet=${encodeURIComponent(sheet)}`,{data});
}
function goPortalWithToken(){
  const TOKEN=qs("token");
  try{
    const u=new URL(PORTAL_URL,location.href);
    u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN);
  }
}

// =============================
// VARIÁVEIS GLOBAIS
// =============================
let patient=null;
let CPF="";
let startAt=Date.now();

// =============================
// INICIALIZAÇÃO (BOOT)
// =============================
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){setBox("#alert","Link inválido (sem token).","err");return;}
    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows?.length)throw new Error("Token inválido ou expirado.");
    const tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired=tokenRow.expires_at&&(Date.parse(tokenRow.expires_at)<Date.now());
    if(disabled||expired)throw new Error("Token desativado/expirado.");

    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF)throw new Error("Token sem CPF vinculado.");
    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows?.length)throw new Error("Paciente não encontrado.");
    patient=prows[0];
    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){setBox("#alert","Formulário não liberado para este participante.","err");return;}

    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const flagDone=String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    if(already?.length||flagDone){
      setBox("#alert","Formulário já respondido. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }
    renderPatientInfo();
    $("#form").style.display="block";
    $("#pacInfo").style.display="grid";
    hideBox("#alert");
    startAt=Date.now();
  }catch(err){
    console.error(err);
    setBox("#alert",err.message||"Falha ao abrir o formulário.","err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo");
  g.innerHTML="";
  const info=[["Nome",patient.nome||"-"],["Nascimento",fmtDateISO(patient.data_nascimento)]];
  for(const [k,v]of info){
    const d=document.createElement("div");
    d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  }
}

// =============================
// PARTE 2 – PERGUNTAS E LÓGICA DO RAADS-R
// =============================

// --- Lista de perguntas ---
const QUESTIONS = [
  "Sou uma pessoa simpática.",
  "Sempre uso frases de filmes e TV nas conversas.",
  "Sempre me surpreendo quando os outros me dizem que fui rude.",
  "Às vezes falo alto ou baixo demais, sem perceber.",
  "Frequentemente não sei como reagir nas situações sociais.",
  "Eu consigo 'me por no lugar do outro'.",
  "Para mim é difícil entender o que algumas frases significam, como 'você é a menina dos meus olhos'.",
  "Eu só gosto de falar com pessoas que tenham os mesmos interesses que os meus.",
  "Eu foco mais nos detalhes do que na ideia geral.",
  "Eu sempre noto a sensação da comida na minha boca. Isso é mais importante do que o próprio gosto.",
  "Tenho saudades dos meus melhores amigos ou da minha família quando estamos separados por um longo tempo.",
  "Às vezes ofendo os outros por dizer o que penso, mesmo sem querer.",
  "Gosto apenas de pensar e falar sobre algumas coisas que me interessam.",
  "Prefiro ir a um restaurante sozinho a ir com alguém que eu conheço.",
  "Não consigo imaginar como seria ser outra pessoa.",
  "Já me disseram que sou desajeitado(a) ou descoordenado(a).",
  "As pessoas me acham estranho(a) ou diferente.",
  "Compreendo quando meus amigos precisam ser confortados.",
  "Sou muito sensível ao toque das roupas. A sensação das roupas no corpo é mais importante do que o modelo.",
  "Gosto de copiar as maneiras de falar e agir de certas pessoas. Isso me ajuda a parecer mais normal.",
  "Para mim, falar com mais de uma pessoa ao mesmo tempo pode ser muito intimidante.",
  "Tenho de 'agir como se fosse normal' para agradar aos outros e fazer com que gostem de mim.",
  "Encontrar-me com pessoas é em geral algo fácil para mim.",
  "Quando alguém me interrompe quando estou falando sobre algo que me é muito interessante, fico extremamente confuso.",
  "Para mim é difícil entender o sentimento das outras pessoas quando estão falando.",
  "Gosto de conversar com várias pessoas ao mesmo tempo, como à mesa, num jantar, na escola ou no trabalho.",
  "Levo as coisas muito ao pé da letra e acabo não entendendo o que as pessoas estão tentando dizer.",
  "Para mim é muito difícil entender quando as pessoas estão envergonhadas ou com inveja.",
  "Algumas texturas que não incomodam os outros me são totalmente agressivas ao toque.",
  "Fico extremamente aborrecido(a) quando a maneira em que costumo fazer as coisas é mudada de repente.",
  "Nunca quis ou nunca precisei do que as outras pessoas chamam de 'relacionamento íntimo'.",
  "Para mim é muito difícil começar ou terminar uma conversa. Preciso continuar até terminar.",
  "Falo num ritmo normal.",
  "O mesmo som, cor ou textura pode mudar de repente de muito delicado para muito grosseiro.",
  "A frase 'estou virado no avesso' me faz me sentir desconfortável.",
  "Às vezes o som de uma palavra ou de um barulho agudo pode fazer doer minhas orelhas.",
  "Sou uma pessoa compreensiva.",
  "Não me conecto com personagens de filmes e não consigo sentir o que sentem.",
  "Não consigo dizer se alguém está me paquerando.",
  "Consigo ver em minha mente, com detalhes exatos, as coisas que me interessam.",
  "Tenho listas das coisas que me interessam, mesmo que não tenham uso prático.",
  "Quando meus sentidos estão sobrecarregados, tenho de me isolar para que eles 'se desliguem'.",
  "Gosto de contar coisas para meus amigos.",
  "Não sei julgar se alguém está interessado ou aborrecido com o que estou falando.",
  "Pode ser difícil para mim ler o rosto e o movimento das mãos e do corpo de alguém que esteja falando.",
  "A mesma coisa (como roupas ou temperaturas) pode parecer bem diferente, para mim, em ocasiões diferentes.",
  "Eu me sinto muito confortável em encontros e ocasiões sociais.",
  "Tento ser o mais prestativo possível quando as pessoas me contam seus problemas pessoais.",
  "Me disseram que tenho uma voz incomum (monótona, infantil ou estridente).",
  "Às vezes um assunto fica 'emperrado' na minha mente, e eu tenho de falar sobre ele, mesmo que ninguém esteja interessado.",
  "Faço certos movimentos repetitivos com minhas mãos (como agitá-las, girar pauzinhos ou linhas, mexer coisas diante dos meus olhos).",
  "Nunca me interessei pelo que a maioria das pessoas considera interessante.",
  "Sou considerado(a) uma pessoa compassiva.",
  "Quando lido com pessoas, sigo uma lista de regras específicas que me ajudam a parecer normal.",
  "Para mim é muito difícil trabalhar em grupos ou fazer parte deles.",
  "Quando falo com alguém, é difícil mudar de assunto. Se a outra pessoa muda de assunto, fico muito aborrecido(a) e confuso(a).",
  "Às vezes cubro as orelhas para bloquear barulhos doloridos (como aspiradores ou pessoas que falam muito ou muito alto).",
  "Consigo conversar e bater papo com as pessoas.",
  "Às vezes, coisas que deveriam ser doloridas não são (por exemplo, quando me machuco ou queimo a mão no forno).",
  "Quando estou falando com alguém, acho difícil saber quando é a minha vez de falar ou de ouvir.",
  "Sou considerado(a) uma pessoa solitária pelos que me conhecem.",
  "Geralmente falo em tom normal.",
  "Gosto que as coisas sejam feitas exatamente do mesmo jeito todos os dias, e mesmo pequenas mudanças nas minhas rotinas me chateiam.",
  "Fazer amigos e socializar é um mistério para mim.",
  "Quando estou estressado(a), rodar ou balançar numa cadeira me acalma.",
  "A frase 'ele faz tudo de barriga' não faz sentido para mim.",
  "Se estou num lugar em que há muitos cheiros, texturas, barulhos ou luzes intensas, fico ansioso(a) ou amedrontado(a).",
  "Sei dizer se alguém está falando uma coisa e querendo dizer outra.",
  "Gosto de ser eu mesmo(a) o máximo possível.",
  "Meus pensamentos estão guardados na minha memória como em fichas de arquivo. Consigo 'pegar' os que preciso, bastando procurar na 'pilha de fichas'.",
  "O mesmo som me parece, às vezes, muito alto ou muito baixo, mesmo quando eu sei que o volume não foi mudado.",
  "Gosto de passar o tempo comendo e conversando com minha família e amigos.",
  "Não tolero coisas que não gosto (como cheiros, texturas, sons ou cores).",
  "Não gosto de ser abraçado(a) ou segurado(a).",
  "Quando vou a algum lugar tenho de seguir uma rotina familiar — ou posso ficar muito confuso(a) e aborrecido(a).",
  "É difícil descobrir o que os outros esperam de mim.",
  "Gosto de ter amigos íntimos.",
  "As pessoas me dizem que sou muito detalhista.",
  "Sempre me dizem que faço perguntas embaraçosas.",
  "Costumo apontar o erro dos outros."
];

// --- Opções de resposta e pontuação ---
const OPTIONS = [
  {label:"Nunca foi verdadeiro",value:0},
  {label:"Verdadeiro apenas quando eu tinha menos de 16 anos",value:1},
  {label:"Verdadeiro apenas hoje",value:2},
  {label:"Verdadeiro hoje e quando eu era jovem",value:3}
];

// --- Itens com pontuação invertida ---
const INVERTED = new Set([1,6,11,18,23,26,33,37,43,47,48,53,58,62,68,72,77]);

// --- Renderização das perguntas ---
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  QUESTIONS.forEach((q,idx)=>{
    const n=idx+1; const qn=String(n).padStart(3,"0");
    const wrap=document.createElement("div");
    wrap.className="q";
    wrap.innerHTML=`<h3>${n}. ${q}</h3>`;
    const opts=document.createElement("div");
    opts.className="opts";
    OPTIONS.forEach((opt,i)=>{
      const id=`q${qn}_${i}`;
      const l=document.createElement("label");
      l.className="opt";
      l.innerHTML=`<input type="radio" name="q${qn}" id="${id}" value="${opt.value}" required><span>${opt.label}</span>`;
      opts.appendChild(l);
    });
    wrap.appendChild(opts);
    host.appendChild(wrap);
  });

  const updateProg=()=>{
    const N=QUESTIONS.length;
    let answered=0;
    for(let i=1;i<=N;i++){
      const qn=String(i).padStart(3,"0");
      if(document.querySelector(`input[name="q${qn}"]:checked`)) answered++;
    }
    $("#progress").textContent=`${answered}/${QUESTIONS.length} respondidas`;
  };
  host.addEventListener("change",()=>{updateProg();autosaveAnswers();});
  updateProg();
}
renderQuestions();

// --- Autosave local ---
function autosaveAnswers(){
  const stored={};
  QUESTIONS.forEach((_,i)=>{
    const qn=String(i+1).padStart(3,"0");
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) stored[i+1]=sel.value;
  });
  localStorage.setItem(AUTOSAVE_KEY,JSON.stringify(stored));
}
function restoreAutosave(){
  try{
    const raw=localStorage.getItem(AUTOSAVE_KEY);
    if(!raw)return;
    const data=JSON.parse(raw);
    Object.entries(data).forEach(([k,v])=>{
      const qn=String(k).padStart(3,"0");
      const el=document.querySelector(`input[name="q${qn}"][value="${v}"]`);
      if(el) el.checked=true;
    });
  }catch(_){}
}
restoreAutosave();

// --- Envio ---
let sending=false;
$("#form").addEventListener("submit",async e=>{
  e.preventDefault();
  if(sending)return;
  sending=true;
  hideBox("#msg");
  const btn=$("#btnSubmit");
  const original=btn.textContent;
  btn.disabled=true;
  btn.textContent="Enviando…";
  try{
    // Coleta respostas
    const answers={};
    QUESTIONS.forEach((_,i)=>{
      const qn=String(i+1).padStart(3,"0");
      const sel=document.querySelector(`input[name="q${qn}"]:checked`);
      answers[i+1]=sel?Number(sel.value):null;
    });

    // Calcula pontuação total
    let total=0;
    for(let i=1;i<=QUESTIONS.length;i++){
      const v=answers[i];
      if(v==null)continue;
      total+=INVERTED.has(i)?(3-v):v;
    }

    // Interpretação geral
    let interpret="";
    if(total=65) interpret="Pontuação mínima para autismo.";
    if(total<=99) interpret="Indícios fortes de autismo.";
    if(total<=159) interpret="Forte evidência de autismo. Provavelmente é autista.";
    if(total<=240) interpret="Evidência muito forte de autismo. Muito provavelmente é autista.";
    else interpret="Valor inválido";

    // Monta string de perguntas e respostas
    const questionsStr=QUESTIONS.map((txt,idx)=>{
      const ans=answers[idx+1];
      const label=OPTIONS.find(o=>o.value==ans)?.label||"Sem resposta";
      return `${idx+1}. ${txt} => ${label}`;
    }).join(" | ");

    const durationSec=Math.round((Date.now()-startAt)/1000);
    const row={
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:qs("token"),
      cpf:patient.cpf,
      code:CODE,
      source:SOURCE,
      submitted_at:new Date().toISOString(),
      questions:questionsStr,
      categoria:interpret,
      metrics:JSON.stringify({total,answers,duration_sec:durationSec})
    };

    await sheetCreate(SHEETS.SCORES,row);
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{
      [`${CODE}_FEITO`]:"sim",
      [`${CODE}_FEITO_AT`]:new Date().toISOString()
    });
    localStorage.removeItem(AUTOSAVE_KEY);
    setBox("#msg","Formulário enviado com sucesso. Retornando ao portal…","ok");
    setTimeout(goPortalWithToken,1500);
  }catch(err){
    console.error(err);
    setBox("#msg",err.message||"Falha ao enviar. Tente novamente.","err");
    sending=false;btn.disabled=false;btn.textContent=original;
  }
});



</script>
</body>
</html>
